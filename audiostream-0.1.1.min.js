/*! audiostream - 0.1.1 - Bernard McManus - 382bb3f - 2014-10-13 */
var _MOJO={},MOJO={};_MOJO.Shared=function(a,b){function c(a){return a.length}function d(b){return a.keys(b)}function e(a){return b.prototype.shift.call(a)}function f(a){return a instanceof b?a:a!==i?[a]:[]}function g(a,b){return{get:a,set:b,configurable:!0}}function h(a){return(a||{})[j]?a[j]:a}var i,j="handleMOJO";return{length:c,keys:d,shift:e,ensureArray:f,descriptor:g,getHandlerFunc:h}}(Object,Array),_MOJO.EventHandler=function(a){function b(a,b,c){var e=this;e.handler=a,e.context=b,e.active=!0,e.callback=function(){},e.args=d(c)}var c=a.Shared,d=c.ensureArray;return b.prototype={invoke:function(a,b){var c=this,e=c.handler;if(c.active&&!a.isBreak&&!a.shouldSkip(e)){var f=c.args.concat(d(b));f.unshift(a),e.apply(c.context,f),c.callback(a,e)}}},b}(_MOJO),_MOJO.Event=function(a,b){function c(b,c){var d=this;d.isBreak=e,d.cancelBubble=e,d.defaultPrevented=e,d.skipHandlers=[],d.target=b,d.type=c,d.timeStamp=a.now()}var d=!0,e=!1,f=b.Shared,g=f.ensureArray,h=f.getHandlerFunc;return c.prototype={skip:function(a){var b=this.skipHandlers;g(a).forEach(function(a){b.push(h(a))})},shouldSkip:function(a){return this.skipHandlers.indexOf(a)>=0},"break":function(){this.isBreak=d},preventDefault:function(){this.defaultPrevented=d},stopPropagation:function(){this.cancelBubble=d}},c}(Date,_MOJO),_MOJO.When=function(a,b,c){function d(a,b){return l(a).map(function(a){return a.handler}).indexOf(b)}function e(a,c){(a instanceof b?a:a.split(" ")).forEach(c)}function f(a,b){return a===b?null:a}var g=c.Shared,h=c.EventHandler,i=c.Event,j=g.keys,k=g.shift,l=g.ensureArray,m=g.length,n=g.getHandlerFunc,o={once:function(){var a=this,b=a._when(arguments);return b.forEach(function(a){a.callback=function(){this.active=!1}}),a},when:function(){var a=this;return a._when(arguments),a},_when:function(a){var b=this,c=k(a),d=m(a)>1?k(a):d,g=[],i=k(a),j=n(i),l=f(i,j);return e(c,function(a,c){g.push(new h(j,l,d)),b._addHandler(a,g[c])}),g},happen:function(a,b){var c=this;return a=c._ensureEType(a),e(a,function(a){var d=c._getHandlers(a,!0),e=new i(c,a);d.filter(function(a){return a.invoke(e,b),!a.active}).forEach(function(b){c._removeHandler(c._getHandlers(a),b.handler)})}),c},dispel:function(a,b){var c=this,d=c._getHandlers(),f=n(b);return a=c._ensureEType(a),e(a,function(a){f?c._removeHandler(d[a],f):delete d[a]}),c},_ensureEType:function(a){return a||j(this._getHandlers()).join(" ")},_getHandlers:function(b,c){var d=this,e=d.handlers=d.handlers||{},f=b?e[b]=e[b]||[]:e;return c?b?f.slice():a.create(f):f},_addHandler:function(a,b){var c=this;c._getHandlers(a).push(b)},_removeHandler:function(a,b){var c=d(a,b);c>=0&&a.splice(c,1)}};return o}(Object,Array,_MOJO),MOJO=function(a){function b(a){a=a||{};var c=this;b.Each(a,function(a,b){c[b]=a}),b.Construct(c)}var c=b.prototype=Object.create(a.When);return c.each=function(a){var c=this;return b.Each(c,a,c.keys),c},c.set=function(a,b){var c=this;return c[a]=b,c.happen("set",a),c},c.remove=function(a){var b=this;return delete b[a],b.happen("remove",a),b},b}(_MOJO),MOJO.Each=function(a){function b(a,b,c){(c||d(a)).forEach(function(c,d){b(a[c],c,d)})}var c=a.Shared,d=c.keys;return b}(_MOJO),MOJO.Create=function(a,b){function c(c){var d=a.create(b.prototype);return b.Each(c,function(a,b){d[b]=a}),d}return c}(Object,MOJO),MOJO.Construct=function(a,b){function c(b){var c={};a.defineProperties(b,{handlers:f(function(){return c}),keys:f(function(){return e(b)}),length:f(function(){return g(b.keys)}),handleMOJO:{value:(b.handleMOJO||function(){}).bind(b),configurable:!0}})}var d=b.Shared,e=d.keys,f=d.descriptor,g=d.length;return c}(Object,_MOJO),function(a){"object"==typeof exports?module.exports=a:window.MOJO=a}(MOJO),window.performance=function(a,b){var c="performance",d="timing",e="now",f="navigationStart",g=a[c]||{},h=g[d]||{};if(!g[e]){var i=h[f]?h[f]:b[e]();g[e]=function(){return b[e]()-i}}return g}(window,Date),window.requestAnimationFrame=function(a,b,c,d){function e(){return b.now()-g}var f="equestAnimationFrame",g=b.now();return a["r"+f]||a["webkitR"+f]||a["mozR"+f]||a["oR"+f]||a["msR"+f]||function(a){var b=c(function(){a(e()),d(b)},1e3/60)}}(window,performance,setTimeout,clearTimeout),window.AudioStream=function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){a=a||{};var b=a.url,c=r(a,"method")?a.method:"GET",d=r(a,"async")?a.async:!0,e=new i;for(var f in a)r(e,f)&&(e[f]=a[f]);e.open(c,b,d),e.send()}function n(){return c.now()}function o(a){return a||function(){}}function p(a,b){e(a,b||1)}function q(a,b){return a.bind(b)}function r(a,b){return a.hasOwnProperty(b)}function s(a){return"boolean"==typeof a}function t(a){return"number"==typeof a&&!k(a)}function u(a){return a instanceof h}function v(a,b,c){a.addEventListener(b,c)}function w(a,b,c){a.removeEventListener(b,c)}function x(a,b){if(!z)throw new j("AudioContext is not supported.");var c=this;b=b||{},c.loop=!1,c.waitForLock=!0,c.each(function(a,d){c[d]=r(b,d)?b[d]:c[d]}),c.key=A,c.context=new z,c.gainNode=c.context.createGain(),c.sources={},c.buffers={},c[O]=0,c.playstate=0,c.busy=!1,c.attemptedStart=0,c.startOffset=0,c.lastTime=0,c.elapsed=0,c._timing=q(c._timing,c),l.Construct(c),f.defineProperties(c,{buffer:{get:function(){return c.buffers[c.key]||A}},source:{get:function(){return c.sources[c.key]||A},set:function(a){c.key&&(c.sources[c.key]=a||A)}},volume:{get:function(){return c.gainNode.gain.value},set:function(a){c.gainNode.gain.value=a}},playable:{get:function(){return c.source!==A}},duration:{get:function(){return 1e3*(c.playable?c.source.buffer.duration:0)}},progress:{get:function(){return Math.round(c.elapsed/(c.duration||1)*1e3)/1e3}},connected:{get:function(){return c[O]===P.indexOf("connected")}},stateText:{get:function(){return P[c[O]]}}}),c.when([N,G],c),a&&c.load(a)}function y(a,b){var c=this;c.url=a,c.data=A,b=s(b)?b:!0,l.Construct(c),f.defineProperty(c,F,{get:function(){return c.data!==A}}),c._readystatechange=q(c._readystatechange,c),c._progress=q(c._progress,c),c._error=q(c._error,c),b&&c.load(a)}var z=a.webkitAudioContext||a.AudioContext,A=null,B=1e3/60,C="prototype",D="loading",E="load",F="ready",G="unlock",H="timing",I="start",J="end",K="error",L="connect",M="disconnect",N="stateChange",O="state",P=["not ready","loaded","ready","connected","disconnected"];return x.isIos=function(){return/(ipad|iphone|ipod)/i.test(b.userAgent)},x[C]=l.Create({load:function(a,b,c){b=b||"main",c=o(c);var d=this,e=d.buffers,f=e[b],g=!(f instanceof y);return d.busy=!0,d.key=b,f=f||new y(a,!1),f.once(E,c),g?(d.started=!1,d.locked=!0,d._setState(0),f.when(D,function(a,b){d.happen(D,b)}).when(E,function(a,b){d.state;d._setState(1),d._initialize(b,function(){d.busy=!1,d._unlock()})}).when(K,function(a,b){d.destroy(!0),d.happen(K,b),c(!1)}).load(),e[b]=f):(d.started=!0,d.locked=!1,f.load(a)),d},_initialize:function(a,b){var c=this,d=c.context,e=c.source||d.createBufferSource();d.decodeAudioData(a,function(a){e.buffer=a,e.loop=!0,c._setState(2),b()}),c.source=e},unlock:function(){var a=this;a.locked&&(a.locked=!1,a.happen(G))},_unlock:function(){function b(){c.playable&&(c.unlock(),w(a,d,b),w(a,e,b))}var c=this,d="touchstart",e="touchmove";x.isIos()&&c.locked?(v(a,d,b),v(a,e,b)):c.unlock()},_setState:function(a){var b=this;a!==b[O]&&(b[O]=a,b.happen(N,[a,P[a]]))},handleMOJO:function(a){var b,c=this,d=arguments;switch(a.type){case G:c.waitForLock?c.start(0,0):c.start();break;case N:switch(b=d[1]){case 1:c.happen(E);break;case 2:c.happen(F),c.attemptedStart&&p(function(){c.play()});break;case 3:c.happen(L,c.startOffset);break;case 4:c.happen(M,c.playstate)}}},connect:function(){var a=this,b=a.source,c=a.gainNode,d=a.context;a.playable&&!a.connected&&(c.connect(d.destination),b.connect(c),a._setState(3),a._startTimer())},disconnect:function(){var a=this,b=a.source,c=a.gainNode;a.playable&&a.connected&&(a.startOffset=0,c.disconnect(0),b.disconnect(0),a._setState(4),a._stopTimer())},_startTimer:function(){var a=this;a.timerLoop=!0,d(a._timing)},_stopTimer:function(){var a=this,b=n()-a.lastTime;a.elapsed+=b>0?b:0,a.timerLoop=!1},_timing:function(a){var b=this;if(b.timerLoop){if(b.connected&&(!b.locked||!b.waitForLock)){if(b.elapsed+=a-(b.lastTime||a),b.elapsed>=b.duration-B){b.elapsed=b.duration;var c=b.volume;b.volume=0,p(function(){b.happen(J),b.stop(),b.volume=c,b.loop&&b.once(F,function(){b.play()})})}b.happen(H,[b.elapsed,b.progress,a])}b.lastTime=a,d(b._timing)}else b.lastTime=0},_getStartArgs:function(a,b,c){var d=this;return a=t(a)?a:0,b=t(b)?b:d.elapsed,c=(t(c)?c:d.duration-b)/1e3,b/=1e3,[a,b,c]},start:function(a,b,c){var d=this;if(d.playable){var e=d.source;if(!d.locked){var f=d._getStartArgs(a,b,c);d.started||e.start.apply(e,f),1===d.playstate&&(d.startOffset=1e3*f[1],d.happen(I,d.startOffset),d.playstate=2),d.started=!0}}},play:function(){var a=this;if(a.busy)a.attemptedStart=n();else if(0===a.state)a.load(A,A,function(){a.attemptedStart=n()});else if(a.playstate)a.connect();else{a.playstate=1;var b=a.attemptedStart?n()-a.attemptedStart:A;a.start(A,b,A),a.connect()}return a},pause:function(){var a=this;return a.disconnect(),a},stop:function(a){var b=this;return b.playstate&&(a=s(a)?a:!0,b.playstate=0,b.disconnect(),b.elapsed=0,b.attemptedStart=0,b.startOffset=0,a?b.load():b.destroy()),b},destroy:function(a){var b=this,c=b.sources,d=b.buffers,e=a||b.key,f=d[e]||new y(A,!1);return b.attemptedStart=0,b.startOffset=0,a===b.key?(f.destroy(!0),delete c[a],delete d[a],b.key=A):f.destroy(),b._setState(0),b}}),y[C]=l.Create({_readystatechange:function(a){var b=this,c=a.target;if(c.readyState==c.DONE){var d=c.response;200==c.status&&u(d)?(b.data=d,b.happen(E,d)):c.onerror()}},_progress:function(a){var b=this;a.total&&b.happen(D,a.loaded/a.total)},_error:function(){var a=this;a.happen(K,new j("Error loading sound."))},load:function(a){var b=this;return!b.ready||a&&a!==b.url?(a=b.url=a||b.url,a&&m({url:a,responseType:"arraybuffer",onreadystatechange:b._readystatechange,onprogress:b._progress,onerror:b._error})):b.happen(E,b.data),b},destroy:function(a){var b=this;b.data=A,a&&(b.url=A,b.dispel())}}),x}(window,navigator,performance,requestAnimationFrame,setTimeout,Object,Array,ArrayBuffer,XMLHttpRequest,Error,isNaN,MOJO);